<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>SIPLOG JUJUY | Monitor Bioceánico</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet">

    <!-- Google Maps Bootstrap (Loader) -->
    <script>
        (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
            key: "AIzaSyAt6ld-4xSysQxpdXgbnz4VEMhxmreC3W0",
            v: "weekly",
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Chakra+Petch:wght@400;600;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f172a;
            overflow: hidden;
            color: #e2e8f0;
        }

        .font-tech {
            font-family: 'Chakra Petch', sans-serif;
        }

        /* Animaciones de Interfaz */
        @keyframes scanline {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.1), transparent);
            animation: scanline 3s linear infinite;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background-color: #22c55e;
            border-radius: 50%;
            position: relative;
        }

        .live-dot::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background-color: #22c55e;
            animation: pulse-ring 1.5s infinite;
        }

        /* Estilos de Mapa y Scroll */
        #map {
            height: 100%;
            width: 100%;
            background-color: #1e293b;
        }

        /* Fallback color */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-active {
            border-bottom: 2px solid #6366f1;
            color: #fff;
            background: rgba(99, 102, 241, 0.1);
        }

        /* Estilos para Notificaciones Toast */
        .toast-enter {
            transform: translateX(100%);
            opacity: 0;
        }
        .toast-enter-active {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toast-exit {
            transform: translateX(0);
            opacity: 1;
        }
        .toast-exit-active {
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="h-screen w-screen relative">

    <!-- 1. PANTALLA DE CARGA (SPLASH SCREEN) -->
    <div id="splash-screen"
        class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="scan-line"></div>
        <!-- Grid Background -->
        <div class="absolute inset-0 opacity-10"
            style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 30px 30px;"></div>

        <div class="relative z-10 text-center max-w-2xl px-4">
            <div
                class="inline-flex p-6 rounded-2xl bg-slate-800 border border-slate-700 shadow-2xl mb-8 relative group">
                <div
                    class="absolute inset-0 bg-indigo-500 blur-xl opacity-20 group-hover:opacity-40 transition duration-500">
                </div>
                <span class="material-symbols-outlined text-7xl text-indigo-500 relative">local_shipping</span>
            </div>

            <h1 class="text-5xl md:text-7xl font-black font-tech tracking-widest text-white mb-2">
                SIPLOG <span class="text-indigo-500">JUJUY</span>
            </h1>
            <p
                class="text-slate-400 text-sm md:text-base uppercase tracking-[0.3em] border-y border-slate-800 py-3 mb-8">
                Sistema de Información y Planificación Logística
            </p>

            <!-- Console Log Visual -->
            <div
                class="bg-slate-950/80 backdrop-blur text-left p-4 rounded-lg border border-slate-800 font-mono text-xs space-y-2 mb-8 shadow-inner max-w-md mx-auto">
                <div class="flex justify-between text-green-500"><span>&gt; SYSTEM_CORE</span><span>ONLINE</span></div>
                <div class="flex justify-between text-green-500"><span>&gt; GEO_SATELLITE</span><span>CONNECTED</span>
                </div>
                <div class="flex justify-between text-indigo-400"><span>&gt; MAP_RENDERER</span><span id="status-api"
                        class="text-green-500 font-bold animate-none">READY</span></div>
            </div>

            <button id="btn-enter" onclick="app.enterSystem()"
                class="group relative bg-indigo-600 hover:bg-indigo-500 text-white px-12 py-4 rounded-xl font-bold tracking-wider shadow-[0_0_30px_rgba(79,70,229,0.4)] transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-wait overflow-hidden cursor-pointer animate-pulse">
                <div
                    class="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 skew-x-12">
                </div>
                <span class="relative flex items-center gap-3">INGRESAR AL SISTEMA <span
                        class="material-symbols-outlined">arrow_forward</span></span>
            </button>
        </div>
    </div>

    <!-- 2. APLICACIÓN PRINCIPAL -->
    <div id="app-container" class="h-full flex flex-col opacity-0 transition-opacity duration-1000">

        <!-- Navbar -->
        <header
            class="bg-slate-900 border-b border-slate-700 h-16 flex items-center justify-between px-4 z-30 shadow-lg shrink-0">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-indigo-400">
                    <span class="material-symbols-outlined text-3xl">satellite_alt</span>
                    <div class="h-8 w-px bg-slate-700 mx-2"></div>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-white tracking-wide font-tech">SIPLOG <span
                            class="text-indigo-500">JUJUY</span></h2>
                    <div class="flex items-center gap-2 text-[10px] text-green-400 font-mono">
                        <div class="live-dot"></div> SISTEMA ONLINE
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden md:block text-right border-r border-slate-700 pr-4 mr-2">
                    <div class="text-[10px] text-slate-500 uppercase">Hora Local</div>
                    <div class="font-mono text-slate-200 font-bold" id="clock">07:13:35</div>
                </div>
                <button onclick="app.openModal('transport')"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-indigo-500/20 transition hover:-translate-y-0.5">
                    <span class="material-symbols-outlined text-sm">add_circle</span>
                    <span class="hidden sm:inline">CARGAR UNIDAD</span>
                </button>
                <button onclick="app.toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><span
                        class="material-symbols-outlined">menu</span></button>
            </div>
        </header>

        <!-- Layout -->
        <main class="flex-1 flex relative overflow-hidden">

            <!-- Sidebar -->
            <aside id="sidebar"
                class="absolute md:relative z-20 w-full md:w-80 h-full bg-slate-900 border-r border-slate-700 flex flex-col sidebar-transition transform -translate-x-full md:translate-x-0 shadow-2xl">
                <!-- Tabs -->
                <div class="flex border-b border-slate-700 bg-slate-800/50">
                    <button id="tab-fleet" onclick="app.switchTab('fleet')"
                        class="flex-1 py-4 text-sm font-medium text-slate-400 hover:text-white transition tab-active flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">local_shipping</span> Flota (<span
                            id="count-fleet">0</span>)
                    </button>
                    <button id="tab-alerts" onclick="app.switchTab('alerts')"
                        class="flex-1 py-4 text-sm font-medium text-slate-400 hover:text-white transition flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">warning</span> Alertas
                    </button>
                </div>

                <!-- Panel: Flota -->
                <div id="panel-fleet" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">
                    <!-- Lista generada por JS -->
                </div>

                <!-- Panel: Alertas -->
                <div id="panel-alerts" class="hidden flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">
                    <button onclick="app.openModal('alert')"
                        class="w-full bg-amber-500/10 border border-amber-500/50 text-amber-500 hover:bg-amber-500 hover:text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm transition font-bold mb-4 group">
                        <span class="material-symbols-outlined group-hover:animate-ping">add_alert</span> NUEVA ALERTA
                    </button>
                    <div id="alert-list-content" class="space-y-3">
                        <!-- Lista generada por JS -->
                    </div>
                </div>
            </aside>

            <!-- Mapa -->
            <div class="flex-1 relative bg-slate-800 w-full h-full">
                <div id="map" class="w-full h-full block"></div>

                <!-- NOTIFICATION CONTAINER -->
                <div id="notification-area" class="absolute top-4 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center gap-2 pointer-events-none w-full max-w-md px-4">
                    <!-- Las notificaciones se inyectarán aquí -->
                </div>

                <!-- Botón Reset Vista -->
                <div class="absolute top-4 right-4 flex flex-col gap-2">
                    <button onclick="app.resetView()"
                        class="bg-slate-900 text-slate-300 p-3 rounded-lg shadow-xl border border-slate-700 hover:text-white hover:border-indigo-500 transition transform hover:scale-105">
                        <span class="material-symbols-outlined">my_location</span>
                    </button>
                </div>

                <!-- Tarjeta de Tracking (Flotante) -->
                <div id="track-card"
                    class="absolute bottom-6 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-slate-900/95 backdrop-blur-md border border-slate-700 p-5 rounded-2xl shadow-2xl transform translate-y-[150%] transition-transform duration-300 z-10">
                    <div class="flex justify-between items-start mb-4 border-b border-slate-700 pb-3">
                        <div>
                            <div class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest mb-1">Unidad
                                Monitoreada</div>
                            <div id="card-plate" class="text-2xl font-bold font-tech text-white">---</div>
                        </div>
                        <button onclick="app.closeCard()" class="text-slate-500 hover:text-white"><span
                                class="material-symbols-outlined">close</span></button>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                        <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                            <div class="text-slate-500 text-[10px] uppercase font-bold">Conductor</div>
                            <div id="card-driver" class="text-slate-200 truncate font-medium mt-1">---</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                            <div class="text-slate-500 text-[10px] uppercase font-bold">Velocidad</div>
                            <div id="card-speed" class="text-green-400 font-mono font-bold mt-1">0 km/h</div>
                        </div>
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-400 mb-2 px-1 font-mono">
                        <span id="card-from">ORIGEN</span>
                        <span id="card-to">DESTINO</span>
                    </div>
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                        <div id="card-progress"
                            class="h-full bg-indigo-500 w-0 transition-all duration-500 relative overflow-hidden">
                            <div class="absolute inset-0 bg-white/20 w-full h-full animate-pulse"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: CARGAR TRANSPORTE -->
    <div id="modal-transport"
        class="fixed inset-0 z-[80] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div id="modal-transport-content"
            class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
            <div class="bg-indigo-600 p-5 flex justify-between items-center shadow-lg">
                <h3 class="text-white font-bold text-lg flex items-center gap-2 font-tech tracking-wide">
                    <span class="material-symbols-outlined">local_shipping</span> REGISTRAR UNIDAD
                </h3>
                <button onclick="app.closeModal('transport')" class="text-indigo-200 hover:text-white transition"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <form onsubmit="app.submitTransport(event)" class="p-6 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Patente</label>
                        <div class="relative">
                            <input type="text" name="plate" required="" placeholder="AA 123 BB"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none font-mono uppercase tracking-widest pl-10 transition">

                            <span class="material-symbols-outlined absolute left-3 top-3 text-slate-500">tag</span>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Empresa</label>
                        <div class="relative">
                            <select name="company" required=""
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none pl-10 transition">
                                <option value="" disabled selected>Selecciona...</option>
                                <option value="Redpack">Redpack</option>
                                <option value="Carga Express">Carga Express</option>
                                <option value="Seal Cargas">Seal Cargas</option>
                            </select>
                            <span
                                class="material-symbols-outlined absolute left-3 top-3 text-slate-500 pointer-events-none">business</span>
                        </div>
                    </div>
                </div>
                
                <!-- RUTA UNIFICADA: Input oculto ya que es única -->
                <input type="hidden" name="routeType" value="integral">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Nombre</label>
                        <div class="relative">
                            <input type="text" name="driverName" required="" placeholder="Juan"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none pl-10 transition">
                            <span class="material-symbols-outlined absolute left-3 top-3 text-slate-500">person</span>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Apellido</label>
                        <div class="relative">
                            <input type="text" name="driverSurname" required="" placeholder="Pérez"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none pl-10 transition">
                            <span class="material-symbols-outlined absolute left-3 top-3 text-slate-500">badge</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Punto
                            Origen</label>
                        <select id="select-start" name="startLocation"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-indigo-500 outline-none cursor-pointer transition appearance-none">
                            <!-- JS Dinámico -->
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Destino</label>
                        <select id="select-direction" name="direction"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-indigo-500 outline-none cursor-pointer transition appearance-none">
                           <!-- JS Dinámico -->
                        </select>
                    </div>
                </div>
                <div class="pt-4 flex gap-3 border-t border-slate-700 mt-2">
                    <button type="button" onclick="app.closeModal('transport')"
                        class="flex-1 py-3 text-slate-400 hover:bg-slate-800 rounded-lg font-bold transition">CANCELAR</button>
                    <button type="submit"
                        class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg hover:shadow-indigo-500/30 transition transform active:scale-95">INICIAR
                        RECORRIDO</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: ALERTA -->
    <div id="modal-alert"
        class="fixed inset-0 z-[80] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div id="modal-alert-content"
            class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
            <div class="bg-amber-600 p-5 flex justify-between items-center shadow-lg">
                <h3 class="text-white font-bold text-lg flex items-center gap-2 font-tech tracking-wide">
                    <span class="material-symbols-outlined">warning</span> REPORTAR INCIDENTE
                </h3>
                <button onclick="app.closeModal('alert')" class="text-amber-100 hover:text-white transition"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <form onsubmit="app.submitAlert(event)" class="p-6 space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Tipo de
                        Incidente</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="type" value="caution" checked="" class="peer hidden">
                            <div
                                class="border border-slate-600 rounded-lg p-2 text-center text-slate-400 hover:bg-slate-800 peer-checked:bg-amber-600/20 peer-checked:border-amber-500 peer-checked:text-amber-400 transition">
                                <span class="material-symbols-outlined block text-2xl mb-1">wb_sunny</span>
                                <span class="text-[10px] font-bold">CLIMA</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="type" value="accident" class="peer hidden">
                            <div
                                class="border border-slate-600 rounded-lg p-2 text-center text-slate-400 hover:bg-slate-800 peer-checked:bg-red-600/20 peer-checked:border-red-500 peer-checked:text-red-400 transition">
                                <span class="material-symbols-outlined block text-2xl mb-1">car_crash</span>
                                <span class="text-[10px] font-bold">CHOQUE</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="type" value="police" class="peer hidden">
                            <div
                                class="border border-slate-600 rounded-lg p-2 text-center text-slate-400 hover:bg-slate-800 peer-checked:bg-blue-600/20 peer-checked:border-blue-500 peer-checked:text-blue-400 transition">
                                <span class="material-symbols-outlined block text-2xl mb-1">local_police</span>
                                <span class="text-[10px] font-bold">CONTROL</span>
                            </div>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Ubicación
                        Aproximada</label>
                    <div class="relative">
                        <select id="select-alert-loc" name="location"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 outline-none cursor-pointer transition appearance-none pl-10">
                            <!-- JS -->
                        </select>
                        <span class="material-symbols-outlined absolute left-3 top-3 text-slate-500">place</span>
                    </div>
                </div>
                <div>
                    <label
                        class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Descripción</label>
                    <textarea name="desc" rows="3" placeholder="Detalles..."
                        class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 outline-none resize-none transition"></textarea>
                </div>
                <div class="pt-4 flex gap-3 border-t border-slate-700 mt-2">
                    <button type="button" onclick="app.closeModal('alert')"
                        class="flex-1 py-3 text-slate-400 hover:bg-slate-800 rounded-lg font-bold transition">CANCELAR</button>
                    <button type="submit"
                        class="flex-1 py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg shadow-lg hover:shadow-amber-500/30 transition transform active:scale-95">ENVIAR
                        REPORTE</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /* === CONFIGURACIÓN Y SISTEMA DE RUTA INTEGRAL === */
        const CONFIG = {
            center: { lat: -23.9, lng: -65.2 }, 
            zoom: 9,
            simSpeed: 0.08, 
            routeFallback: false,
            alertRadius: 0.05 
        };

        // Definición de la RUTA ÚNICA INTEGRADA (OESTE -> ESTE)
        const ROUTES = {
            integral: {
                id: 'integral',
                name: 'Corredor Integral (Jama - Salta)',
                color: '#6366f1', // Indigo
                nodes: [
                    { id: 'jama', name: 'Paso de Jama', lat: -23.2375, lng: -67.0764 },
                    { id: 'susques', name: 'Susques', lat: -23.4038, lng: -66.3664 },
                    { id: 'salinas', name: 'Salinas Grandes', lat: -23.6196, lng: -65.8576 },
                    { id: 'lipan', name: 'Cuesta de Lipán', lat: -23.6882, lng: -65.6460 },
                    { id: 'purmamarca', name: 'Purmamarca', lat: -23.7483, lng: -65.4923 },
                    { id: 'volcan', name: 'Volcán', lat: -23.9167, lng: -65.4667 },
                    { id: 'yala', name: 'Yala', lat: -24.1189, lng: -65.4055 },
                    { id: 'jujuy', name: 'S.S. de Jujuy', lat: -24.1858, lng: -65.2995 },
                    { id: 'perico', name: 'Acceso Sur (Perico)', lat: -24.3687, lng: -65.1037 }, 
                    { id: 'san_pedro', name: 'San Pedro de Jujuy', lat: -24.2270, lng: -64.8687 },
                    { id: 'libertador', name: 'Libertador Gral. San Martín', lat: -23.8138, lng: -64.7923 },
                    { id: 'yuto', name: 'Yuto', lat: -23.6394, lng: -64.4727 },
                    { id: 'limite_salta', name: 'Límite con Salta', lat: -23.5186, lng: -64.4048 }
                ],
                labels: { asc: 'Hacia Limite (Salta)', desc: 'Hacia Frontera (Chile)' }
            }
        };

        /* === ESTADO APLICACIÓN === */
        const state = {
            map: null,
            google: null,
            directionsService: null,
            routePaths: {}, 
            transports: [],
            alerts: [],
            markers: {},
            selectedId: null
        };

        /* === CONTROLADOR === */
        const app = {
            // 1. INIT
            init: () => {
                setTimeout(() => {
                    const status = document.getElementById('status-api');
                    if (status) {
                        status.innerText = "READY";
                        status.className = "text-green-500 font-bold animate-none";
                        const btn = document.getElementById('btn-enter');
                        btn.disabled = false;
                        btn.classList.remove('cursor-wait');
                        btn.classList.add('cursor-pointer', 'animate-pulse');
                    }
                }, 1500);

                // Iniciar dropdowns con valor por defecto (única ruta)
                app.handleRouteChange('integral');
                app.populateAlertDropdown();
                app.startClock();
            },

            // 2. INGRESAR
            enterSystem: async () => {
                const btn = document.getElementById('btn-enter');
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> CONECTANDO SATÉLITE...';

                try {
                    await app.initMap();
                    await app.calculateRoutes();
                    app.initData();
                    app.startSimulation();

                    const splash = document.getElementById('splash-screen');
                    const main = document.getElementById('app-container');
                    splash.style.opacity = '0';
                    main.classList.remove('opacity-0');
                    setTimeout(() => splash.style.display = 'none', 800);
                } catch (error) {
                    console.error("Error crítico:", error);
                    btn.innerText = "ERROR DE SISTEMA";
                    btn.classList.add('bg-red-600');
                }
            },

            // 3. MAPA
            initMap: async () => {
                const { Map, Polyline } = await google.maps.importLibrary("maps");
                const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
                const { DirectionsService } = await google.maps.importLibrary("routes");

                state.google = { Map, Polyline, AdvancedMarkerElement, PinElement, DirectionsService };
                state.directionsService = new DirectionsService();

                state.map = new Map(document.getElementById("map"), {
                    center: CONFIG.center,
                    zoom: CONFIG.zoom,
                    mapId: 'DEMO_MAP_ID',
                    disableDefaultUI: true,
                    gestureHandling: 'greedy',
                    mapTypeId: 'terrain',
                    backgroundColor: '#1e293b'
                });

                // Marcadores de Ciudades
                Object.values(ROUTES).forEach(route => {
                    route.nodes.forEach(n => {
                        const pin = new PinElement({ scale: 0.6, background: '#334155', borderColor: '#475569', glyph: '' });
                        new AdvancedMarkerElement({
                            map: state.map,
                            position: { lat: n.lat, lng: n.lng },
                            content: pin.element,
                            title: n.name
                        });
                    });
                });
            },

            // 4. CÁLCULO DE RUTAS
            calculateRoutes: async () => {
                const calcSingleRoute = (routeKey) => {
                    return new Promise((resolve) => {
                        const routeDef = ROUTES[routeKey];
                        const nodes = routeDef.nodes;
                        
                        // Google Maps tiene un límite de waypoints. Dividiremos si es muy largo, 
                        // pero para este demo asumimos que encaja o simplificamos.
                        // Para garantizar que funcione en la demo, usamos start y end y waypoints intermedios.
                        
                        const request = {
                            origin: nodes[0], // Jama
                            destination: nodes[nodes.length - 1], // Salta limit
                            waypoints: nodes.slice(1, -1).map(n => ({ location: { lat: n.lat, lng: n.lng }, stopover: false })),
                            travelMode: 'DRIVING'
                        };

                        state.directionsService.route(request, (result, status) => {
                            if (status === 'OK') {
                                const path = result.routes[0].overview_path;
                                state.routePaths[routeKey] = path; 

                                new state.google.Polyline({
                                    path: path,
                                    geodesic: true,
                                    strokeColor: routeDef.color,
                                    strokeOpacity: 0.7,
                                    strokeWeight: 4,
                                    map: state.map
                                });

                                // Mapear índices 
                                nodes.forEach(node => {
                                    let minDst = Infinity;
                                    let closestIdx = 0;
                                    path.forEach((p, i) => {
                                        const d = Math.sqrt(Math.pow(p.lat() - node.lat, 2) + Math.pow(p.lng() - node.lng, 2));
                                        if (d < minDst) { minDst = d; closestIdx = i; }
                                    });
                                    node.pathIndex = closestIdx;
                                });
                                console.log(`Ruta ${routeKey} cargada OK`);
                            } else {
                                console.warn(`Fallo ruta ${routeKey}, fallback lineal`);
                                state.routePaths[routeKey] = nodes.map(n => new google.maps.LatLng(n.lat, n.lng));
                            }
                            resolve();
                        });
                    });
                };

                await calcSingleRoute('integral');
            },

            // 5. DATA INICIAL
            initData: () => {
                // Ejemplo: Viaje completo desde frontera
                app.createTransport({ 
                    plate: "AD 440 JK", company: "TransNOA", driver: "Carlos M.", 
                    routeType: 'integral', startLocation: "jama", direction: "asc" // Hacia Salta (Este)
                });
                
                // Ejemplo: Viaje desde el ramal hacia chile
                app.createTransport({ 
                    plate: "AE 112 BB", company: "Logística Jujuy", driver: "Roberto S.", 
                    routeType: 'integral', startLocation: "libertador", direction: "desc" // Hacia Chile (Oeste)
                }); 
                
                // Ejemplo: En capital
                app.createTransport({ 
                    plate: "AF 990 ZZ", company: "Redpack", driver: "Juan P.", 
                    routeType: 'integral', startLocation: "jujuy", direction: "asc" // Hacia Salta
                });

                const alert1 = { id: 1, type: 'caution', title: 'Viento Blanco', desc: 'Precaución en Paso de Jama.', location: 'jama', routeType: 'integral' };
                //const alert2 = { id: 2, type: 'police', title: 'Control Rutina', desc: 'Gendarmería en acceso a Yuto.', location: 'yuto', routeType: 'integral' };
                
                //state.alerts.push(alert1, alert2);
                state.alerts.push(alert1);
                app.renderAlertList();
                app.createAlertMarker(alert1);
                //app.createAlertMarker(alert2);
                app.renderFleetList();
            },

            // 6. LOGICA TRANSPORTE
            createTransport: (data) => {
                const routeDef = ROUTES[data.routeType];
                if (!routeDef) return;

                const startNode = routeDef.nodes.find(n => n.id === data.startLocation);
                if (!startNode) return;

                const path = state.routePaths[data.routeType];
                if (!path || path.length === 0) return;

                let currentPathIdx = startNode.pathIndex !== undefined ? startNode.pathIndex : 0;
                let endPathIdx = data.direction === 'asc' ? path.length - 1 : 0;

                if(currentPathIdx >= path.length) currentPathIdx = 0;

                const t = {
                    id: Date.now() + Math.random(),
                    ...data,
                    currentPathIdx: currentPathIdx,
                    targetPathIdx: endPathIdx,
                    speed: (CONFIG.simSpeed + (Math.random() * 0.05)) * (data.direction === 'asc' ? 1 : -1),
                    lat: startNode.lat,
                    lng: startNode.lng,
                    lastNodeName: startNode.name,
                    notifiedAlerts: new Set()
                };

                state.transports.push(t);
                app.addTransportMarker(t);
            },

            addTransportMarker: (t) => {
                const el = document.createElement('div');
                el.className = "group relative cursor-pointer";
                el.innerHTML = `
                    <div class="absolute bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] px-2 py-1 rounded border border-slate-600 opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-20 shadow-lg pointer-events-none font-bold tracking-wider">
                        ${t.plate}
                    </div>
                    <div class="w-10 h-10 rounded-full bg-indigo-600 border-2 border-white shadow-[0_0_15px_rgba(99,102,241,0.6)] flex items-center justify-center transform transition hover:scale-110 active:scale-95">
                        <span class="material-symbols-outlined text-white text-lg">local_shipping</span>
                    </div>
                `;
                el.onclick = (e) => { e.stopPropagation(); app.selectTransport(t.id); };

                const marker = new state.google.AdvancedMarkerElement({
                    map: state.map,
                    position: { lat: t.lat, lng: t.lng },
                    content: el,
                    title: t.plate,
                    zIndex: 100
                });
                state.markers[t.id] = marker;
            },

            // 7. SIMULACIÓN
            startSimulation: () => {
                setInterval(() => {
                    state.transports.forEach(t => {
                        const path = state.routePaths[t.routeType];
                        if (!path) return;

                        if ((t.direction === 'asc' && t.currentPathIdx >= t.targetPathIdx) ||
                            (t.direction === 'desc' && t.currentPathIdx <= t.targetPathIdx)) {
                            return; 
                        }

                        t.currentPathIdx += t.speed;
                        const pIdx = Math.floor(t.currentPathIdx);

                        if (pIdx >= 0 && pIdx < path.length) {
                            const point = path[pIdx];
                            t.lat = typeof point.lat === 'function' ? point.lat() : point.lat;
                            t.lng = typeof point.lng === 'function' ? point.lng() : point.lng;

                            const routeDef = ROUTES[t.routeType];
                            routeDef.nodes.forEach(n => {
                                if (n.pathIndex && Math.abs(n.pathIndex - pIdx) < 20) t.lastNodeName = n.name; 
                            });
                        }

                        app.checkProximity(t);

                        if (state.markers[t.id]) {
                            state.markers[t.id].position = { lat: t.lat, lng: t.lng };
                        }

                        if (state.selectedId === t.id) app.updateCard(t);
                    });
                }, 50); 
            },

            checkProximity: (t) => {
                state.alerts.forEach(alert => {
                    if(t.notifiedAlerts.has(alert.id)) return;
                    
                    // Encontrar el nodo alerta
                    const route = ROUTES.integral;
                    const target = route.nodes.find(n => n.id === alert.location);

                    if(!target) return;

                    const dist = Math.sqrt(Math.pow(t.lat - target.lat, 2) + Math.pow(t.lng - target.lng, 2));

                    if(dist < CONFIG.alertRadius) {
                        t.notifiedAlerts.add(alert.id);
                        app.showNotification(t, alert);
                    }
                });
            },

            showNotification: (t, alert) => {
                const container = document.getElementById('notification-area');
                
                const colorClass = alert.type === 'accident' ? 'bg-red-500' : (alert.type === 'police' ? 'bg-blue-500' : 'bg-amber-500');
                const icon = alert.type === 'accident' ? 'car_crash' : (alert.type === 'police' ? 'local_police' : 'warning');

                const toast = document.createElement('div');
                toast.className = `w-full bg-slate-900 border-l-4 ${colorClass.replace('bg-', 'border-')} shadow-2xl rounded-r-lg p-4 flex items-center gap-4 toast-enter pointer-events-auto`;
                toast.innerHTML = `
                    <div class="rounded-full p-2 bg-slate-800 ${colorClass.replace('bg-', 'text-')}">
                        <span class="material-symbols-outlined animate-pulse">${icon}</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-[15px] text-slate-400 font-bold uppercase tracking-widest flex justify-between">
                            <span>PROXIMIDAD DETECTADA</span>
                            <span>${t.plate}</span>
                        </div>
                        <div class="font-bold text-white text-sm leading-tight mt-1">
                            ${alert.title} en zona próxima
                        </div>
                    </div>
                `;

                container.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.classList.remove('toast-enter');
                    toast.classList.add('toast-enter-active');
                });

                setTimeout(() => {
                    toast.classList.remove('toast-enter-active');
                    toast.classList.add('toast-exit-active');
                    setTimeout(() => toast.remove(), 500);
                }, 5000);
            },

            // 8. INTERACCIÓN UI
            selectTransport: (id) => {
                state.selectedId = id;
                const t = state.transports.find(x => x.id === id);
                if (!t) return;
                state.map.panTo({ lat: t.lat, lng: t.lng });
                const card = document.getElementById('track-card');
                card.classList.remove('translate-y-[150%]');
                app.updateCard(t);
            },

            updateCard: (t) => {
                const routeDef = ROUTES[t.routeType];
                document.getElementById('card-plate').innerText = t.plate;
                document.getElementById('card-driver').innerText = t.driver;
                document.getElementById('card-speed').innerText = Math.abs(Math.floor(t.speed * 120)) + " km/h";
                document.getElementById('card-from').innerText = t.lastNodeName || "EN RUTA"; 
                
                const labels = routeDef.labels;
                const destName = t.direction === 'asc' ? labels.asc : labels.desc;
                document.getElementById('card-to').innerText = destName;

                let pct = 0;
                const path = state.routePaths[t.routeType];
                if(path) {
                    pct = (t.currentPathIdx / path.length) * 100;
                    if(t.direction === 'desc') pct = 100 - pct;
                }
                document.getElementById('card-progress').style.width = Math.min(Math.max(pct, 0), 100) + "%";
            },

            closeCard: () => {
                state.selectedId = null;
                document.getElementById('track-card').classList.add('translate-y-[150%]');
            },

            // MANEJO DE CAMBIO DE RUTA EN MODAL
            handleRouteChange: (routeKey) => {
                const routeDef = ROUTES[routeKey];
                const startSelect = document.getElementById('select-start');
                const dirSelect = document.getElementById('select-direction');

                // Llenar Origen
                startSelect.innerHTML = routeDef.nodes.map(n => `<option value="${n.id}">${n.name}</option>`).join('');
                
                // Llenar Direcciones
                dirSelect.innerHTML = `
                    <option value="asc">${routeDef.labels.asc}</option>
                    <option value="desc">${routeDef.labels.desc}</option>
                `;
            },

            // Llenar dropdown de alertas con TODOS los nodos de TODAS las rutas
            populateAlertDropdown: () => {
                const select = document.getElementById('select-alert-loc');
                const route = ROUTES.integral;
                
                let html = `<optgroup label="${route.name}">` + 
                        route.nodes.map(n => `<option value="${n.id}">${n.name}</option>`).join('') + 
                        `</optgroup>`;
                
                select.innerHTML = html;
            },

            submitTransport: (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                data.driver = `${data.driverName} ${data.driverSurname}`;
                
                app.createTransport(data);
                app.renderFleetList();
                app.closeModal('transport');
                app.switchTab('fleet');
                e.target.reset();
            },

            submitAlert: (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                const titles = { caution: 'Precaución', accident: 'Accidente', police: 'Control' };
                // Al ser una sola ruta, el tipo es siempre integral
                const rType = 'integral';

                const alert = { id: Date.now(), ...data, title: titles[data.type], routeType: rType };
                state.alerts.unshift(alert);
                app.createAlertMarker(alert);
                app.renderAlertList();
                app.closeModal('alert');
                app.switchTab('alerts');
                e.target.reset();
            },

            createAlertMarker: (a) => {
                const el = document.createElement('div');
                const color = a.type === 'accident' ? 'text-red-500' : (a.type === 'police' ? 'text-blue-500' : 'text-amber-500');
                const icon = a.type === 'accident' ? 'car_crash' : (a.type === 'police' ? 'local_police' : 'warning');
                el.innerHTML = `<span class="material-symbols-outlined ${color} text-3xl drop-shadow-md animate-bounce">${icon}</span>`;

                // Buscar nodo en la ruta integral
                let loc = ROUTES.integral.nodes.find(n => n.id === a.location);

                if (loc) {
                    new state.google.AdvancedMarkerElement({
                        map: state.map,
                        position: { lat: loc.lat + 0.005, lng: loc.lng },
                        content: el,
                        title: a.title
                    });
                }
            },

            renderFleetList: () => {
                const list = document.getElementById('panel-fleet');
                document.getElementById('count-fleet').innerText = state.transports.length;
                list.innerHTML = state.transports.map(t => {
                    return `
                    <div onclick="app.selectTransport(${t.id})" class="bg-slate-800 p-3 rounded-lg border border-slate-700 hover:border-indigo-500 cursor-pointer transition flex justify-between items-center group mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-slate-900 flex items-center justify-center text-slate-400 font-bold text-xs border border-slate-600 font-mono shadow-inner">${t.plate.substring(0, 2)}</div>
                            <div>
                                <div class="font-bold text-slate-200 text-sm group-hover:text-indigo-400 font-mono tracking-wide transition">${t.plate}</div>
                                <div class="text-[10px] text-slate-500 uppercase">${t.company}</div>
                            </div>
                        </div>
                        <div class="text-[10px] text-indigo-400 bg-indigo-900/20 px-2 py-0.5 rounded border border-indigo-900/50 font-bold flex items-center gap-1">
                            <div class="live-dot w-1.5 h-1.5 bg-indigo-500"></div> EN RUTA
                        </div>
                    </div>
                `}).join('');
            },

            renderAlertList: () => {
                const list = document.getElementById('alert-list-content');
                list.innerHTML = state.alerts.map(a => {
                    // Buscar nombre nodo
                    let locName = 'Ruta';
                    const found = ROUTES.integral.nodes.find(n => n.id === a.location);
                    if(found) locName = found.name;

                    const color = a.type === 'accident' ? 'red' : (a.type === 'police' ? 'blue' : 'amber');
                    const icon = a.type === 'accident' ? 'car_crash' : (a.type === 'police' ? 'local_police' : 'warning');
                    return `
                    <div class="bg-slate-800 p-3 rounded-lg border-l-4 border-${color}-500 mb-2 cursor-pointer hover:bg-slate-750 transition shadow-sm group">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="text-${color}-500 text-sm font-bold flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">${icon}</span> ${a.title}
                            </h4>
                            <span class="text-[10px] text-slate-500 uppercase">AHORA</span>
                        </div>
                        <p class="text-xs text-slate-300 leading-relaxed mb-2 group-hover:text-white">${a.desc}</p>
                        <div class="text-[10px] text-slate-400 uppercase font-bold bg-slate-900/50 p-1 px-2 rounded w-fit flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">location_on</span> ${locName}
                        </div>
                    </div>`;
                }).join('');
            },

            startClock: () => setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString('es-AR');
            }, 1000),

            toggleSidebar: () => document.getElementById('sidebar').classList.toggle('-translate-x-full'),

            switchTab: (tab) => {
                document.getElementById('tab-fleet').classList.toggle('tab-active', tab === 'fleet');
                document.getElementById('tab-alerts').classList.toggle('tab-active', tab === 'alerts');
                document.getElementById('panel-fleet').classList.toggle('hidden', tab !== 'fleet');
                document.getElementById('panel-alerts').classList.toggle('hidden', tab !== 'alerts');
            },

            openModal: (id) => {
                const m = document.getElementById(`modal-${id}`);
                const c = document.getElementById(`modal-${id}-content`);
                m.classList.remove('hidden');
                setTimeout(() => { c.classList.remove('scale-95', 'opacity-0'); c.classList.add('scale-100', 'opacity-100'); }, 10);
            },

            closeModal: (id) => {
                const m = document.getElementById(`modal-${id}`);
                const c = document.getElementById(`modal-${id}-content`);
                c.classList.remove('scale-100', 'opacity-100'); c.classList.add('scale-95', 'opacity-0');
                setTimeout(() => m.classList.add('hidden'), 300);
            },

            resetView: () => state.map && (state.map.setCenter(CONFIG.center), state.map.setZoom(CONFIG.zoom))
        };

        // Iniciar al Cargar
        document.addEventListener('DOMContentLoaded', app.init);

    </script>

</body>

</html>